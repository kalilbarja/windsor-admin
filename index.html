<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windsor Properties | Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --green-dark: #2D4A2D;
            --green-mid: #3D5A3D;
            --green-light: #4A6B4A;
            --green-pale: rgba(61, 90, 61, 0.1);
            --gold: #8B7D3A;
            --white: #FFFFFF;
            --gray-light: #F5F5F3;
            --gray-border: #E5E5E3;
            --gray-text: #6B6B6B;
            --black: #1A1A1A;
            --red: #DC3545;
            --red-light: #FFF5F5;
            --yellow: #F0AD4E;
            --yellow-light: #FFFBF0;
            --blue: #0066CC;
            --blue-light: #F0F7FF;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-light);
            color: var(--black);
            line-height: 1.6;
        }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--green-dark) 0%, var(--green-mid) 100%);
        }
        .login-container { width: 100%; max-width: 400px; padding: 2rem; }
        .login-logo { text-align: center; margin-bottom: 2rem; color: white; font-size: 1.5rem; font-weight: 600; }
        .login-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        }
        .login-card h1 { font-size: 1.25rem; text-align: center; margin-bottom: 0.5rem; }
        .login-card .subtitle { font-size: 0.85rem; color: var(--gray-text); text-align: center; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; font-family: inherit; font-size: 0.9rem;
            border: 1px solid var(--gray-border); border-radius: 8px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--green-mid); box-shadow: 0 0 0 3px var(--green-pale);
        }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.25rem; font-family: inherit; font-size: 0.9rem; font-weight: 500;
            border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--green-mid); color: white; }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-secondary { background: var(--gray-light); color: var(--black); }
        .btn-secondary:hover { background: var(--gray-border); }
        .btn-danger { background: var(--red); color: white; }
        .btn-small { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
        .btn-full { width: 100%; }
        .login-error {
            background: var(--red-light); color: var(--red); padding: 0.75rem;
            border-radius: 8px; font-size: 0.85rem; margin-bottom: 1rem; display: none;
        }

        /* App Layout */
        .app { display: none; }
        .app.active { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 240px; background: var(--white); border-right: 1px solid var(--gray-border);
            display: flex; flex-direction: column; position: fixed; top: 0; bottom: 0; left: 0;
        }
        .sidebar-header { padding: 1.25rem; border-bottom: 1px solid var(--gray-border); }
        .sidebar-logo { font-size: 1.1rem; font-weight: 600; color: var(--green-dark); }
        .sidebar-logo span { font-size: 0.75rem; color: var(--gray-text); display: block; font-weight: 400; }
        .sidebar-nav { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-section-title {
            font-size: 0.7rem; font-weight: 600; color: var(--gray-text);
            text-transform: uppercase; letter-spacing: 0.05em; padding: 0 1rem; margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 1rem;
            color: var(--gray-text); font-size: 0.875rem; cursor: pointer;
            border: none; background: none; width: 100%; text-align: left; transition: all 0.2s;
        }
        .nav-item:hover { background: var(--gray-light); color: var(--black); }
        .nav-item.active { background: var(--green-pale); color: var(--green-mid); font-weight: 500; }
        .nav-item svg { width: 18px; height: 18px; }
        .nav-badge {
            margin-left: auto; background: var(--red); color: white;
            font-size: 0.7rem; padding: 0.125rem 0.5rem; border-radius: 50px;
        }
        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--gray-border); }
        .admin-info { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .admin-avatar {
            width: 36px; height: 36px; background: var(--green-mid); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.8rem;
        }
        .admin-name { font-size: 0.85rem; font-weight: 500; }
        .admin-role { font-size: 0.75rem; color: var(--gray-text); }
        .logout-btn {
            display: flex; align-items: center; gap: 0.5rem; width: 100%;
            padding: 0.5rem 0.75rem; background: none; border: 1px solid var(--gray-border);
            border-radius: 6px; color: var(--gray-text); font-size: 0.8rem; cursor: pointer;
        }
        .logout-btn:hover { background: var(--red-light); border-color: var(--red); color: var(--red); }
        .lang-toggle { display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.75rem; }
        .lang-btn {
            background: none; border: none; font-size: 0.8rem; color: var(--gray-text);
            cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px;
        }
        .lang-btn.active { color: var(--green-mid); background: var(--green-pale); font-weight: 500; }

        /* Main Content */
        .main-content { flex: 1; margin-left: 240px; padding: 1.5rem; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
        .page-header h1 { font-size: 1.5rem; font-weight: 600; }
        .page-header p { font-size: 0.9rem; color: var(--gray-text); }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card {
            background: var(--white); border-radius: 12px; border: 1px solid var(--gray-border); padding: 1.25rem;
        }
        .stat-icon {
            width: 40px; height: 40px; border-radius: 8px; display: flex;
            align-items: center; justify-content: center; margin-bottom: 0.75rem;
        }
        .stat-icon.yellow { background: var(--yellow-light); color: var(--yellow); }
        .stat-icon.blue { background: var(--blue-light); color: var(--blue); }
        .stat-icon.green { background: var(--green-pale); color: var(--green-mid); }
        .stat-value { font-size: 1.75rem; font-weight: 600; }
        .stat-label { font-size: 0.85rem; color: var(--gray-text); }

        /* Cards */
        .card {
            background: var(--white); border-radius: 12px; border: 1px solid var(--gray-border); margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-border);
        }
        .card-title { font-size: 1rem; font-weight: 600; }
        .card-body { padding: 1.25rem; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--gray-border); margin-bottom: 1rem; }
        .tab {
            padding: 0.75rem 1.25rem; font-size: 0.9rem; color: var(--gray-text);
            background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;
        }
        .tab:hover { color: var(--black); }
        .tab.active { color: var(--green-mid); border-bottom-color: var(--green-mid); font-weight: 500; }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--gray-border); }
        th { font-size: 0.75rem; font-weight: 600; color: var(--gray-text); text-transform: uppercase; background: var(--gray-light); }
        td { font-size: 0.875rem; }
        tr:hover { background: var(--gray-light); }
        .status {
            display: inline-block; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500;
        }
        .status-pending { background: var(--yellow-light); color: var(--yellow); }
        .status-in-progress { background: var(--blue-light); color: var(--blue); }
        .status-completed { background: var(--green-pale); color: var(--green-mid); }
        .status-active { background: var(--green-pale); color: var(--green-mid); }
        .status-inactive { background: var(--gray-light); color: var(--gray-text); }

        /* Actions */
        .actions { display: flex; gap: 0.25rem; }
        .action-btn {
            background: none; border: none; padding: 0.375rem; cursor: pointer;
            color: var(--gray-text); border-radius: 4px;
        }
        .action-btn:hover { background: var(--gray-light); color: var(--black); }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white); border-radius: 16px; width: 100%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-border);
        }
        .modal-header h2 { font-size: 1.1rem; font-weight: 600; }
        .modal-close {
            background: none; border: none; padding: 0.5rem; cursor: pointer;
            color: var(--gray-text); border-radius: 6px;
        }
        .modal-close:hover { background: var(--gray-light); }
        .modal-body { padding: 1.25rem; }
        .modal-footer {
            display: flex; justify-content: flex-end; gap: 0.75rem;
            padding: 1rem 1.25rem; border-top: 1px solid var(--gray-border);
        }

        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-grid .full-width { grid-column: span 2; }

        /* Detail View */
        .detail-section { margin-bottom: 1.5rem; }
        .detail-section h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--gray-text); }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .detail-item { background: var(--gray-light); padding: 0.75rem; border-radius: 8px; }
        .detail-label { font-size: 0.75rem; color: var(--gray-text); margin-bottom: 0.25rem; }
        .detail-value { font-size: 0.9rem; font-weight: 500; }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem; color: var(--gray-text); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5; }

        /* Toast */
        .toast {
            position: fixed; bottom: 2rem; right: 2rem; background: var(--green-mid); color: white;
            padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1001;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--red); }

        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .form-grid .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="login-page">
    <div class="login-container">
        <div class="login-logo"><img src="windsor-logo.png" alt="Windsor Properties" style="height:150px;width:auto;"><br><span style="font-size:0.9rem;font-weight:400;color:white;">Panel de Administración</span></div>
        <div class="login-card">
            <h1>Iniciar Sesión</h1>
            <p class="subtitle">Acceso solo para administradores</p>
            <div id="loginError" class="login-error"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Correo Electrónico</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Iniciar Sesión</button>
            </form>
        </div>
    </div>
</div>

<!-- App -->
<div id="app" class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><img src="windsor-logo.png" alt="Windsor Properties" style="height:100px;width:auto;"><span>Panel de Administración</span></div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <button class="nav-item active" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                    Dashboard
                </button>
                <button class="nav-item" data-page="requests">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Solicitudes
                    <span class="nav-badge" id="pendingBadge">0</span>
                </button>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Gestión</div>
                <button class="nav-item" data-page="residents">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Residentes
                </button>
                <button class="nav-item" data-page="properties">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Propiedades
                </button>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div>
                    <div class="admin-name" id="adminName">Admin</div>
                    <div class="admin-role" id="adminRole">Administrador</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Cerrar Sesión
            </button>
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLang('es')">ES</button>
                <span style="color:var(--gray-text)">|</span>
                <button class="lang-btn" onclick="setLang('en')">EN</button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page active">
            <div class="page-header">
                <div>
                    <h1>Dashboard</h1>
                    <p>Resumen de actividad</p>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon yellow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </div>
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    </div>
                    <div class="stat-value" id="statInProgress">0</div>
                    <div class="stat-label">En Progreso</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <div class="stat-value" id="statCompleted">0</div>
                    <div class="stat-label">Completadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    </div>
                    <div class="stat-value" id="statResidents">0</div>
                    <div class="stat-label">Residentes Activos</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Solicitudes Recientes</h3>
                    <button class="btn btn-secondary btn-small" onclick="showPage('requests')">Ver Todas</button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Residente</th><th>Unidad</th><th>Categoría</th><th>Fecha</th><th>Estado</th></tr>
                            </thead>
                            <tbody id="recentRequestsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Requests Page -->
        <div id="page-requests" class="page">
            <div class="page-header">
                <div>
                    <h1>Solicitudes de Mantenimiento</h1>
                    <p>Gestionar todas las solicitudes</p>
                </div>
            </div>
            <div class="card">
                <div class="tabs">
                    <button class="tab active" data-tab="pending">Pendientes</button>
                    <button class="tab" data-tab="in_progress">En Progreso</button>
                    <button class="tab" data-tab="completed">Completadas</button>
                    <button class="tab" data-tab="all">Todas</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Residente</th><th>Unidad</th><th>Categoría</th><th>Ubicación</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr>
                        </thead>
                        <tbody id="requestsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Residents Page -->
        <div id="page-residents" class="page">
            <div class="page-header">
                <div>
                    <h1>Residentes</h1>
                    <p>Gestionar cuentas de residentes</p>
                </div>
                <button class="btn btn-primary" onclick="showAddResidentModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    Agregar Residente
                </button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Nombre</th><th>Correo</th><th>Teléfono</th><th>Unidad</th><th>Pago Mensual</th><th>Estado</th><th>Acciones</th></tr>
                        </thead>
                        <tbody id="residentsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Properties Page -->
        <div id="page-properties" class="page">
            <div class="page-header">
                <div>
                    <h1>Propiedades</h1>
                    <p>Gestionar propiedades y unidades</p>
                </div>
                <button class="btn btn-primary" onclick="showAddPropertyModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    Agregar Propiedad
                </button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Propiedad</th><th>Dirección</th><th>Unidades</th><th>Ocupadas</th><th>Acciones</th></tr>
                        </thead>
                        <tbody id="propertiesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Request Detail Modal -->
<div id="requestModal" class="modal-overlay" onclick="closeModal('requestModal', event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:600px;">
        <div class="modal-header">
            <h2>Detalles de Solicitud</h2>
            <button class="modal-close" onclick="closeModal('requestModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="modal-body" id="requestModalContent"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('requestModal')">Cerrar</button>
            <button class="btn btn-primary" id="saveRequestBtn" onclick="saveRequestChanges()">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Add Resident Modal -->
<div id="residentModal" class="modal-overlay" onclick="closeModal('residentModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="residentModalTitle">Agregar Residente</h2>
            <button class="modal-close" onclick="closeModal('residentModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="residentForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="resName" required>
                    </div>
                    <div class="form-group">
                        <label>Correo Electrónico *</label>
                        <input type="email" id="resEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="tel" id="resPhone" placeholder="+1 809 555 1234">
                    </div>
                    <div class="form-group">
                        <label>Unidad *</label>
                        <select id="resUnit" required></select>
                    </div>
                    <div class="form-group">
                        <label>Pago Mensual (RD$)</label>
                        <input type="number" id="resPayment" placeholder="25000">
                    </div>
                    <div class="form-group">
                        <label>Contraseña *</label>
                        <input type="password" id="resPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Inicio de Contrato</label>
                        <input type="date" id="resLeaseStart">
                    </div>
                    <div class="form-group">
                        <label>Fin de Contrato</label>
                        <input type="date" id="resLeaseEnd">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('residentModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="saveResident()">Guardar</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
    // ==============================================
    // CONFIGURATION
    // ==============================================
    const SUPABASE_URL = 'https://xwfcddnggaogrjavrzyc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZmNkZG5nZ2FvZ3JqYXZyenljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNTU0MDQsImV4cCI6MjA4MzkzMTQwNH0.HeD2WxhDueNEEIA1X1nrp7Q5umOIVYJtb6c0HEv1z7c';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentAdmin = null;
    let currentRequestId = null;
    let allRequests = [];
    let allResidents = [];
    let allUnits = [];
    let currentTab = 'pending';

    // ==============================================
    // AUTHENTICATION
    // ==============================================
    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) throw error;

            // Check if user is admin
            const { data: admin, error: adminError } = await db
                .from('admin_users')
                .select('*')
                .eq('user_id', data.user.id)
                .single();

            if (adminError || !admin) {
                throw new Error('No tiene permisos de administrador');
            }

            currentAdmin = admin;
            showApp();
        } catch (error) {
            document.getElementById('loginError').textContent = error.message;
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function logout() {
        db.auth.signOut();
        currentAdmin = null;
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('app').classList.remove('active');
    }

    function showApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('app').classList.add('active');
        
        document.getElementById('adminName').textContent = currentAdmin.name;
        document.getElementById('adminRole').textContent = currentAdmin.role === 'admin' ? 'Administrador' : 'Asistente';
        document.getElementById('adminAvatar').textContent = currentAdmin.name.split(' ').map(n => n[0]).join('').substring(0, 2);

        loadDashboardData();
        loadRequests();
        loadResidents();
        loadUnits();
    }

    // ==============================================
    // DATA LOADING
    // ==============================================
    async function loadDashboardData() {
        const { data: requests } = await db.from('maintenance_requests').select('status');
        const { data: residents } = await db.from('residents').select('status');

        const pending = requests?.filter(r => r.status === 'pending').length || 0;
        const inProgress = requests?.filter(r => r.status === 'in_progress').length || 0;
        const completed = requests?.filter(r => r.status === 'completed').length || 0;
        const activeResidents = residents?.filter(r => r.status === 'active').length || 0;

        document.getElementById('statPending').textContent = pending;
        document.getElementById('statInProgress').textContent = inProgress;
        document.getElementById('statCompleted').textContent = completed;
        document.getElementById('statResidents').textContent = activeResidents;
        document.getElementById('pendingBadge').textContent = pending;
    }

    async function loadRequests() {
        const { data, error } = await db
            .from('maintenance_requests')
            .select('*, residents(name), units(identifier)')
            .order('created_at', { ascending: false });

        if (error) { console.error(error); return; }
        allRequests = data || [];
        renderRequests();
        renderRecentRequests();
    }

    function renderRequests() {
        const filtered = currentTab === 'all' ? allRequests : allRequests.filter(r => r.status === currentTab);
        const tbody = document.getElementById('requestsTable');
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--gray-text);padding:2rem;">No hay solicitudes</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(r => `
            <tr>
                <td>#${r.id.substring(0, 8)}</td>
                <td>${r.residents?.name || 'N/A'}</td>
                <td>${r.units?.identifier || 'N/A'}</td>
                <td>${getCategoryName(r.category)}</td>
                <td>${getLocationName(r.location)}</td>
                <td>${formatDate(r.created_at)}</td>
                <td><span class="status status-${r.status.replace('_', '-')}">${getStatusName(r.status)}</span></td>
                <td>
                    <div class="actions">
                        <button class="action-btn" onclick="viewRequest('${r.id}')" title="Ver">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function renderRecentRequests() {
        const recent = allRequests.slice(0, 5);
        const tbody = document.getElementById('recentRequestsTable');
        
        if (recent.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray-text);padding:2rem;">No hay solicitudes</td></tr>';
            return;
        }

        tbody.innerHTML = recent.map(r => `
            <tr onclick="viewRequest('${r.id}')" style="cursor:pointer;">
                <td>${r.residents?.name || 'N/A'}</td>
                <td>${r.units?.identifier || 'N/A'}</td>
                <td>${getCategoryName(r.category)}</td>
                <td>${formatDate(r.created_at)}</td>
                <td><span class="status status-${r.status.replace('_', '-')}">${getStatusName(r.status)}</span></td>
            </tr>
        `).join('');
    }

    async function loadResidents() {
        const { data, error } = await db
            .from('residents')
            .select('*, units(identifier)')
            .order('name');

        if (error) { console.error(error); return; }
        allResidents = data || [];
        renderResidents();
    }

    function renderResidents() {
        const tbody = document.getElementById('residentsTable');
        
        if (allResidents.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray-text);padding:2rem;">No hay residentes</td></tr>';
            return;
        }

        tbody.innerHTML = allResidents.map(r => `
            <tr>
                <td>${r.name}</td>
                <td>${r.email}</td>
                <td>${r.phone || '-'}</td>
                <td>${r.units?.identifier || 'N/A'}</td>
                <td>${r.monthly_payment ? 'RD$ ' + Number(r.monthly_payment).toLocaleString() : '-'}</td>
                <td><span class="status status-${r.status === 'active' ? 'active' : 'inactive'}">${r.status === 'active' ? 'Activo' : 'Inactivo'}</span></td>
                <td>
                    <div class="actions">
                        <button class="action-btn" onclick="editResident('${r.id}')" title="Editar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function loadUnits() {
        const { data, error } = await db.from('units').select('*, properties(name), residents(id)');
        if (error) { console.error(error); return; }
        allUnits = data || [];
        renderProperties();
        populateUnitSelect();
    }

    function renderProperties() {
        const properties = {};
        allUnits.forEach(u => {
            const pName = u.properties?.name || 'Sin Propiedad';
            if (!properties[pName]) properties[pName] = { units: 0, occupied: 0 };
            properties[pName].units++;
            if (u.residents?.length > 0) properties[pName].occupied++;
        });

        const tbody = document.getElementById('propertiesTable');
        const entries = Object.entries(properties);
        
        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray-text);padding:2rem;">No hay propiedades</td></tr>';
            return;
        }

        tbody.innerHTML = entries.map(([name, data]) => `
            <tr>
                <td><strong>${name}</strong></td>
                <td>-</td>
                <td>${data.units}</td>
                <td>${data.occupied}</td>
                <td>-</td>
            </tr>
        `).join('');
    }

    function populateUnitSelect() {
        const select = document.getElementById('resUnit');
        select.innerHTML = '<option value="">Seleccionar unidad</option>' + 
            allUnits.map(u => `<option value="${u.id}">${u.identifier} - ${u.properties?.name || ''}</option>`).join('');
    }

    // ==============================================
    // REQUEST MANAGEMENT
    // ==============================================
    async function viewRequest(id) {
        currentRequestId = id;
        const request = allRequests.find(r => r.id === id);
        if (!request) return;

        document.getElementById('requestModalContent').innerHTML = `
            <div class="detail-section">
                <h3>Información de la Solicitud</h3>
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-label">Residente</div><div class="detail-value">${request.residents?.name || 'N/A'}</div></div>
                    <div class="detail-item"><div class="detail-label">Unidad</div><div class="detail-value">${request.units?.identifier || 'N/A'}</div></div>
                    <div class="detail-item"><div class="detail-label">Categoría</div><div class="detail-value">${getCategoryName(request.category)}</div></div>
                    <div class="detail-item"><div class="detail-label">Ubicación</div><div class="detail-value">${getLocationName(request.location)}</div></div>
                    <div class="detail-item"><div class="detail-label">Fecha</div><div class="detail-value">${formatDate(request.created_at)}</div></div>
                    <div class="detail-item"><div class="detail-label">Contacto</div><div class="detail-value">${request.contact_phone || request.contact_email || '-'}</div></div>
                </div>
            </div>
            <div class="detail-section">
                <h3>Descripción</h3>
                <p style="background:var(--gray-light);padding:1rem;border-radius:8px;">${request.description}</p>
            </div>
            <div class="detail-section">
                <h3>Gestión</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="reqStatus">
                            <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                            <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>En Progreso</option>
                            <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Programada</label>
                        <input type="date" id="reqScheduled" value="${request.scheduled_date || ''}">
                    </div>
                    <div class="form-group full-width">
                        <label>Notas Internas</label>
                        <textarea id="reqNotes" rows="2">${request.internal_notes || ''}</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Qué se arregló</label>
                        <textarea id="reqFixed" rows="2">${request.what_was_fixed || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Costo Total (RD$)</label>
                        <input type="number" id="reqCost" value="${request.total_cost || ''}">
                    </div>
                </div>
            </div>
        `;

        document.getElementById('requestModal').classList.add('active');
    }

    async function saveRequestChanges() {
        if (!currentRequestId) return;

        const updates = {
            status: document.getElementById('reqStatus').value,
            scheduled_date: document.getElementById('reqScheduled').value || null,
            internal_notes: document.getElementById('reqNotes').value,
            what_was_fixed: document.getElementById('reqFixed').value,
            total_cost: document.getElementById('reqCost').value || null
        };

        const { error } = await db.from('maintenance_requests').update(updates).eq('id', currentRequestId);

        if (error) {
            showToast('Error al guardar', true);
            return;
        }

        showToast('Solicitud actualizada');
        closeModal('requestModal');
        loadRequests();
        loadDashboardData();
    }

    // ==============================================
    // RESIDENT MANAGEMENT
    // ==============================================
    function showAddResidentModal() {
        document.getElementById('residentModalTitle').textContent = 'Agregar Residente';
        document.getElementById('residentForm').reset();
        document.getElementById('resPassword').required = true;
        document.getElementById('residentModal').classList.add('active');
    }

    async function saveResident() {
        const name = document.getElementById('resName').value;
        const email = document.getElementById('resEmail').value;
        const phone = document.getElementById('resPhone').value;
        const unitId = document.getElementById('resUnit').value;
        const payment = document.getElementById('resPayment').value;
        const password = document.getElementById('resPassword').value;
        const leaseStart = document.getElementById('resLeaseStart').value;
        const leaseEnd = document.getElementById('resLeaseEnd').value;

        if (!name || !email || !unitId || !password) {
            showToast('Complete los campos requeridos', true);
            return;
        }

        try {
            // Create auth user
            const { data: authData, error: authError } = await db.auth.signUp({
                email,
                password,
                options: { data: { name } }
            });

            if (authError) throw authError;

            // Create resident record
            const { error: resError } = await db.from('residents').insert({
                user_id: authData.user.id,
                name,
                email,
                phone,
                unit_id: unitId,
                monthly_payment: payment || null,
                lease_start: leaseStart || null,
                lease_end: leaseEnd || null
            });

            if (resError) throw resError;

            showToast('Residente creado exitosamente');
            closeModal('residentModal');
            loadResidents();
            loadDashboardData();
        } catch (error) {
            showToast(error.message, true);
        }
    }

    // ==============================================
    // NAVIGATION
    // ==============================================
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
    }

    // ==============================================
    // UTILITIES
    // ==============================================
    function closeModal(modalId, event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById(modalId).classList.remove('active');
        }
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast' + (isError ? ' error' : '');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function formatDate(dateStr) {
        return new Date(dateStr).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    const categoryNames = { plumbing: 'Plomería', electrical: 'Eléctrico', hvac: 'HVAC', appliances: 'Electrodomésticos', doors_windows: 'Puertas/Ventanas', pest_control: 'Plagas', structural: 'Estructural', other: 'Otro' };
    const locationNames = { kitchen: 'Cocina', bathroom_main: 'Baño Principal', bathroom_secondary: 'Baño Secundario', bedroom: 'Dormitorio', living_room: 'Sala', laundry: 'Lavandería', exterior: 'Exterior', common_area: 'Área Común' };
    const statusNames = { pending: 'Pendiente', in_progress: 'En Progreso', completed: 'Completado' };

    function getCategoryName(cat) { return categoryNames[cat] || cat; }
    function getLocationName(loc) { return locationNames[loc] || loc; }
    function getStatusName(status) { return statusNames[status] || status; }

    function setLang(lang) {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.textContent === lang.toUpperCase()));
    }

    // ==============================================
    // INIT
    // ==============================================
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const page = item.getAttribute('data-page');
            if (page) showPage(page);
        });
    });

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentTab = tab.getAttribute('data-tab');
            renderRequests();
        });
    });

    // Check existing session
    db.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            db.from('admin_users').select('*').eq('user_id', session.user.id).single()
                .then(({ data }) => {
                    if (data) {
                        currentAdmin = data;
                        showApp();
                    }
                });
        }
    });
</script>

</body>
</html>
